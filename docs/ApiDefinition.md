# API Definition

## Errors in responses

An error in a response contains the following fields:

| Name | Type | Description |
| --- | --- | --- |
| `code` | string | a unique code that identifies the error.
| `summary` | string | A description of the function that generated the error
| `detail` | string | The error message.

The code describes both the summary and the detail. The code looks like

``` text
E<number>-<string>
```

The number identifies the summary, the string refers to the detail. The number 0
is reserved for system errors.

There are a few generic errors that can occur with any query. These errors won't
be repeated in the descriptions below.

| Code | Description |
| --- |  --- |
| `E0-E15` | The request does not exist |
| `E<n>-INTERNAL` | This is an unknown error. If this occurs, create a bug report.
| `E<n>-DATABASE` | The database becomes unavailable. If the database is unavailable at startup, the server won't start. So this has a different reason. Contact your system administrator. Typically a table or record is locked. |
| `E<n>-FOREIGNKEY` | The request access elements in the database that don't exist |
| `E<n>-UNIQUE` | You are trying to create an element that already exists |

The server side may discover new errors over time. If a new error is detected an
unknown error is raised. This error can be recognized by the code: the string
portion will be `INTERNAL`. Time to create an error report.

## Generic

### `GET /OK`

This call can be used to validate that the API is responding

#### Parameters

None

#### Request body

N/A

#### Response body

* `status`: always has the value `ok`

##### Example

```json
{
    "status": "ok"
}
```

* `200`: success

## Places

Places are locations where you can store items.

Fields:

| Name | Type | Description |
| --- | --- | --- |
| `ìd` | number | a unique internal identifier
| `label` | string | a unique name to identify the place
| `createdAt` | date time | the time and date the place was created
| `updatedAt` | date time | the time and date the place was updated

### `GET /places`

This REST call locks returns all defined places.

#### Parameters

N/A

#### Request body

N/A

#### Response body

The call returns the list of places. This contains an array of places. Each entry
contains the `id`, `label`, `createdAt`, and `updatedAt` fields

##### Example

```json
[
    {
        "id": 1,
        "label": "Diepvries",
        "createdAt": "2021-03-04T16:03:20.020Z",
        "updatedAt": "2021-03-04T16:03:20.020Z"
    },
    {
        "id": 2,
        "label": "Wijnrek",
        "createdAt": "2021-03-04T16:03:38.638Z",
        "updatedAt": "2021-03-04T16:03:38.638Z"
    }
]
```

#### Return codes

* `200`: success

### `POST /places`

This REST call creates a new place.

#### Parameters

N/A

#### Request body

* `label`: label of the place to create

#### Response body

The call returns the list of places. This contains an array of places. Each entry
contains the `id`, `label`, `createdAt`, and `updatedAt` fields

##### Example

```json
{
    "id": 1,
    "label": "Diepvries",
    "createdAt": "2021-03-04T16:03:20.020Z",
    "updatedAt": "2021-03-04T16:03:20.020Z"
}
```

#### Return codes

* `200`: success
* `400`:
  * `E3-UNIQUE`: the label must be unique.

## Labels

Labels are identifiers that are linked to items. The link is done in the UI. The
idea behind the labels is that different types of labels can used: bar codes, QR
codes, and perhaps even covers of containers.

Currently, only *automatic* labels are supported. These are labels that are
generated by the system and proposed to the user. To facilitate this the front
end manages a cache of labels.

### `PUT /labels`

This REST call locks a set of calls of automatic labels. The frontend maintains
a cache of automatic labels through this call

#### Parameters

N/A

#### Request body

* `count`: the number of labels to lock and return.

##### Example

```json
{
    "count": 10
}
```

#### Response body

The call returns a list of locked labels

##### Example

```json
[
    102,
    103,
    104,
    105,
    106,
    107,
    108,
    109,
    110,
    111
]
```

#### Return codes

* `200`: success

## Items

Items is what it is all about!

Fields:

| Name | Type | Description |
| --- | --- | --- |
| `ìd` | number | a unique internal identifier
| `description` | string | what is the item
| `quantity` | string | an indication of the quantity
| `uikey` | string | a reference used by the UI
| `labelid` | number | refers to the label
| `placeid` | number | refers to the place for the item
| `place.id` | number | refers to the place for item (same as placeid)
| `place.name` | number | label of to the place where for the item (same as placeid)
| `createdAt` | date time | the time and date the place was created
| `updatedAt` | date time | the time and date the place was updated

`Placeid` may not be present in the returned item.

### `GET /items`

This REST call will return some items. The items will be filtered based on the
parameters passed on input.

#### Parameters

| parameter | description |
| --- | --- |
| `p` | a predefined filter. See below for more detail

Valid options for the parameter p are:

| option | description |
| --- | --- |
| `itemdescriptions` | this returns a list of distinct item definitions in the database. It does not take the state of the item into account.
| `stored` | this returns a list items stored in the system not in the trashcan

#### Request body

* N/A

#### Response body

The response body depends on the query. If the predefined filter is
`itemdescriptions`, the call returns an array of item descriptions.

##### Example

```json
[
    "courgettesoep",
    "tomatensoep",
    "tomatensoep met balletjes"
]
```

The predefined filter `stored` returns an array of items. This array contains
the following fields:

* `id`
* `description`
* `quantity`
* `uikey`
* `labelid`
* `createdAt`
* `updatedAt`
* A description of the place:
  * `id`
  * `label`

##### Example

```json
[
    {
        "id": 1,
        "description": "courgettesoep",
        "quantity": "2p",
        "uikey": "a",
        "labelid": 51,
        "createdAt": "2021-03-11T07:40:54.112Z",
        "updatedAt": "2021-03-11T07:40:54.112Z",
        "place": {
            "id": 1,
            "label": "Diepvries"
        }
    },
    {
        "id": 2,
        "description": "courgettesoep",
        "quantity": "2p",
        "uikey": "a",
        "labelid": 52,
        "createdAt": "2021-03-11T07:58:45.089Z",
        "updatedAt": "2021-03-11T07:58:45.089Z",
        "place": {
            "id": 1,
            "label": "Diepvries"
        }
    }
]
```

#### Return codes

* `200`: success
* `400`: A bad request

Errors returned when the status is `400`:
| Code | Description |
| --- | --- |
| `E2-IE3` | The predefined query is not recognized.

### `GET /items/:id`

This REST call will return a single item with the given internal identifier, if it exists.

#### Parameters

| parameter | mandatory | description |
| --- | --- | --- |
| `id` | Y | a predefined filter. See below for more detail

#### Request body

* N/A

#### Response body

The item

##### Example


##### Example

```json
{
    "id": 1,
    "description": "courgettesoep",
    "quantity": "2p",
    "uikey": "a",
    "labelid": 51,
    "createdAt": "2021-03-11T07:40:54.112Z",
    "updatedAt": "2021-03-11T07:40:54.112Z",
    "place": {
        "id": 1,
        "label": "Diepvries"
    }
}
```

#### Return codes

* `200`: success
* `400`: A bad request

Errors returned when the status is `400`:
| Code | Description |
| --- | --- |
| `E2-IE3` | The predefined query is not recognized.

### `POST /items`

This REST call creates one or more items.

#### Parameters

N/A

#### Request body

The request contains a single object or an array of objects. The fields are

* `description`: mandatory and not empty.
* `quantity`: optional.
* `uikey`: optional
* `labelid`: a reference to an unused label id.
* `placeid`: a reference to the place where it is stored.

#### Response body

In case of a `200` response, the following structure is returned:

| Name | Type | Description |
| --- | --- | --- |
| `successCnt` | number | the number of items the are successfully created
| `errorCnt` | number | the number of items the could not be created.
| `results` | array | array of results, one per requested create.

Even if all the requests failed, the call will return a `200` status. An error status
is returned when an unexpected error in the procedure occurred.

| Name | Type | Description |
| --- | --- | --- |
| `uikey` | string | if it was passed in the call
| `labelid` | number | this is the key that can be  used for further communication.
| `result` | string | This field equals `ok` or `error`, indicating if the creation succeeded or not.
| `error` | Error | This is only present if the result field indicates an error.

##### Example

```json
{
    "successCnt": 1,
    "errorCnt": 3,
    "results": [
        {
            "uikey": "a",
            "labelid": 2000000,
            "result": "error",
            "error": {
                "summary": "Aanmaak van artikelen",
                "code": "E1-IE1",
                "detail": "Het etiket(2000000) bestaat niet."
            }
        },
        {
            "uikey": "a",
            "labelid": 50,
            "result": "error",
            "error": {
                "summary": "Aanmaak van artikelen",
                "code": "E1-NOTNULL",
                "detail": "omschrijving is een verplicht veld."
            }
        },
        {
            "uikey": "a",
            "labelid": 52,
            "result": "ok"
        },
        {
            "uikey": "a",
            "labelid": 51,
            "result": "error",
            "error": {
                "summary": "Aanmaak van artikelen",
                "code": "E1-IE2",
                "detail": "Het etiket(51) is al in gebruik."
            }
        }
    ]
}
```

#### Return codes

* `200`: success
* `400`: Bad request

In the error objects in the results array the following codes can occur:

| Code | Description |
| --- | --- |
| `E1-IE1` | The label id does not exist|
| `E1-IE2` | The label id is already in use|
| `E1-NOTNULL` | the description was not passed or empty
| `E1-EMPTY` | the description passed contained only white space

### PATCH /items/:id

#### Parameters

* `id`: the internal id of the item.

The internal `id` should not be confused with the `labelid`. Both are
identifying attributes but the user should never see the `id`.

#### Request body

The request contains a single object. The fields are

| Name | Type | Mandatory | Comment |
| --- | --- | --- | --- |
| `ìd` | number | N | This must be the same as the parameter
| `description` | string | N | Modifies the database field
| `quantity` | string | N | Modifies the database field
| `uikey` | string | N | Modifies the database field
| `labelid` | number | N | Must be the same as the one in the database
| `place.id` | number | N | Modifies the database field `placeid`
| `updatedAt` | date time | Y | Must be the same as the database field
| `op` | string | N | Other elements in the backend can be changed through this parameter.

Other fields may be passed but they are ignored.

The field `op` can have the following values:

| Name | Comment |
| --- | --- |
| `destroy` | The item is moved to the trash can
| `restore` | The item is restored from the trash can

#### Response body

The response body always contains a message and sometimes the item. The message
takes the form of an error message as described above.

The table below shows the different messages, the corresponding
HTTP error code, whether the item is returned and a description.

| Code | HTTP | Item | Description
| --- | --- | --- | --- |
| `E4-IE4` | 400 | N | There is no item with the given parameter
| `E4-IE5` | 409 | Y | The `updateAt` in the request body and in the database do not match.
| `E4-IE6` | 400 | Y | Information in the database does not match with the request body
| `E4-IE7` | 400 | Y | There is no `updatedAt` field in the request body
| `E4-IE8` | 200 | Y | The changes were successful
| `E4-IE9` | 200 | N | The item was successfully moved to the thrash
| `E4-IE10` | 200 | Y | The item was successfully restored from the thrash
| `E4-IE11` | 400 | N | The `op` field was invalid
| `E4-IE12` | 400 | Y | The item was already in the trashcan
| `E4-IE13` | 400 | Y | The item was not in trashcan

If the item is not returned, the result takes the format of an error message.

##### Example

```json
{
    "code": "E4-IE4",
    "detail": "Het artikel kon niet gevonden worden.",
    "summary": "Wijzigen van artikelen"
}
```

If the item is returned, the message and item are returned as a separate block.
The item may sometimes contain useless fields like `placeid` or `deleteAt`. These
can be safely ignored.
##### Example

```json
{
    "message": {
        "code": "E4-IE8",
        "detail": "Het artikel werd succesvol gewijzigd",
        "summary": "Wijzigen van artikelen"
    },
    "item": {
        "id": 2,
        "description": "Chili sin carne",
        "quantity": "3p",
        "uikey": "kn4mc4q2",
        "labelid": 13,
        "deletedAt": null,
        "createdAt": "2021-04-05T13:18:52.834Z",
        "updatedAt": "2021-04-15T07:16:17.542Z",
        "place": {
            "id": 1,
            "label": "Diepvries"
        }
    }
}
```

#### Return codes

* `200`: success
* `400`: Bad request
* `409`: Conflict

## Label Files (DEPRECATED)

### `GET /label/files/:id` (DEPRECATED)

Downloads the generated PDF file after a successful generation.

#### Parameters

* `ìd`: An id returned by [`POST /label/files`](#post-labelfiles)

#### Request body

N/A

#### Response body

The downloaded PDF file.

#### Return codes

* `200`: success
* `400`: The following error codes can be returned
  * `CLF_4`: The passed `ìd` is not valid.

### `POST /label/files` (DEPRECATED)

Create a set of labels that can be printed. This only does the generation of the
file. The download is done by a different API

#### Parameters

None

#### Request body

* `type`: the name of a label type.
  * type: string
  * see [`GET /label/types`](#get-labeltypes)

* `npages`: (optional, defaults to 1)
  * type: number;
  * there is a maximum number of pages that can be requested
  * if the value cannot be interpreted correctly the default value is used

##### Example

```json
{
    "type": "APLI A4 3x8",
    "npages": 1
}
```

#### Response body

* `id`: a key for the job
* `npages`: the number of pages used
* `type`: the name of a label type used
* `message`: additional information about the execution of the job

##### Example

```json
{
    "id": "kkdnidqh",
    "npages": 1,
    "type": "APLI A4 3x8",
    "message": "Het PDF-bestand wordt gegenereerd. "
}
```

#### Return codes

* `200`: success
* `400`: The following error codes can be returned
  * `CLF_1`: the label type was missing.
  * `CLF_2`: the label type was not recognized.
  * `CLF_3`: the label generation of the label file failed.

## Label Types (DEPRECATED)

### `GET /label/types` (DEPRECATED)

Get a list of the names of all label types.

#### Parameters

None

#### Request body

N/A

#### Response body

An array of strings. Each element in the string represents the name of a label type

#### Return codes

* `200`: success
* `500`: unexpected internal error
